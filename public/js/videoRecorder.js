const rc=document.querySelector(".recorded-video-wrap"),video=document.querySelector(".video-feedback"),rcOptions=document.querySelector(".recorder-options"),hintsWrapper=document.querySelector(".resultHintWrapper"),editorStyles=getComputedStyle(codeEditorWrapper);let isAutoRec=!1,cssIteration=0,htmlIteration=0,jsIteration=0,stream=null,audio=null,mixedStream=null,chunks=[],recorder=null;function justNumbers(e){let t=e.replace(/[^0-9]/g,"");return parseInt(t)}startButton=null,stopButton=null,downloadButton=null,recordedVideo=null;let editorPadStyle=justNumbers(editorStyles.padding);function changeAutoRec(){isAutoRec=!0,startRecording()}async function setupStream(){try{stream=await navigator.mediaDevices.getDisplayMedia({video:{width:{ideal:1920,max:1920},height:{ideal:1080,max:1080},frameRate:{ideal:30}}}),audio=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:44100}}),setupVideoFeedback()}catch(e){console.error(e)}}function setupVideoFeedback(){rcOptions.classList.add("sleepyBtn"),stream?(video.srcObject=stream,video.play()):console.warn("No stream available")}function closeHints(){hintsWrapper.classList.add("hiddenHints"),mobileViewsWrapper.classList.remove("hiddenHints"),!0===isMobileDevice&&goSmallScreenShortcut()}async function getHint(e){const t=jsCodeEdit.textContent;console.log(jsCodeEdit.textContent),console.log(t);let n={data:t};return(await fetch(e,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json()}async function awaitHint(){loadSpinner(),hintsWrapper.innerHTML='<div onclick="closeHints()" id="closeHint" class="closeHint">Close &times;</div>';await getHint("https://hint.code-javascript.com/codejshintops").then((e=>{codeJSHintRes=JSON.parse(e);try{codeJSHintRes.functions.forEach((e=>{let t=document.createElement("span");t.id="hintfunc",t.innerText=` \r\n function declaration: function name = "${e.name}" at line  ${e.line} - character ${e.character} - with ${e.metrics.parameters} parameters.\r\n`,hintsWrapper.appendChild(t)}))}catch{console.log("no hint")}try{codeJSHintRes.globals.forEach((e=>{let t=document.createElement("span");t.id="hintGlo",t.innerText=` \r\n global declaration: global name = "${e}" \r\n `,hintsWrapper.appendChild(t)}))}catch{console.log("no hint")}try{codeJSHintRes.unused.forEach((e=>{let t=document.createElement("span");t.id="hintUn",t.innerText=` \r\n unsued global: name = "${e.name}" at line  ${e.line} - character ${e.character}\r\n `,hintsWrapper.appendChild(t)}))}catch{console.log("no hint")}try{codeJSHintRes.errors.forEach((e=>{let t=document.createElement("span");t.id="hintErr",t.innerText=` \r\n error: at line  ${e.line} - reason: ${e.reason} \r\n `,hintsWrapper.appendChild(t)}))}catch{console.log("no hint")}hintsWrapper.classList.remove("hiddenHints"),mobileViewsWrapper.classList.add("hiddenHints"),!0===isMobileDevice&&goFullScreen(),hideSpinner()}))}async function startRecording(){await setupStream(),stream&&audio?(mixedStream=new MediaStream([...stream.getTracks(),...audio.getTracks()]),recorder=new MediaRecorder(mixedStream),recorder.ondataavailable=handleDataAvailable,recorder.onstop=handleStop,recorder.start(1e3),startButton.classList.add("sleepyBtn"),stopButton.classList.remove("sleepyBtn"),rcOptions.classList.add("sleepyBtn"),!0===isAutoRec&&checkForAutomation()):console.warn("No stream available.")}function stopRecording(){recorder.stop(),loadSpinner(),saveFileAfterVideo(),stopButton.classList.add("sleepyBtn"),startButton.classList.remove("sleepyBtn")}function handleDataAvailable(e){chunks.push(e.data)}function handleStop(e){const t=new Blob(chunks,{type:"video/mp4"});chunks=[],downloadButton.href=URL.createObjectURL(t),downloadButton.download="video.mp4",downloadButton.disabled=!1,recordedVideo.src=URL.createObjectURL(t),recordedVideo.load(),recordedVideo.onloadeddata=function(){rc.classList.remove("sleepyBtn"),recordedVideo.classList.remove("sleepyBtn"),setTimeout((()=>{recordedVideo.play()}),15e3)},stream.getTracks().forEach((e=>e.stop())),audio.getTracks().forEach((e=>e.stop()))}function closeRecVideo(e,t){t.target.classList.contains("recorded-video-wrap")&&(rc.classList.add("sleepyBtn"),recordedVideo.classList.add("sleepyBtn"))}function closeRecOptions(e,t){(t.target.classList.contains("recorder-options")||t.target.classList.contains("recBtn"))&&rcOptions.classList.add("sleepyBtn")}function openRecOptions(){isAutoRec=!1,cssIteration=0,htmlIteration=0,jsIteration=0,rcOptions.classList.remove("sleepyBtn")}const cssBeautifyRecOptions={indent_size:2,space_in_empty_paren:!1,space_in_paren:!1,indent_empty_lines:!1,preserve_newlines:!1},jsBeautifyRecOptions={indent_size:2,indent_char:" ",indent_with_tabs:!1,editorconfig:!1,eol:"\n",end_with_newline:!1,indent_level:0,preserve_newlines:!0,max_preserve_newlines:1,space_in_paren:!1,space_in_empty_paren:!1,jslint_happy:!1,space_after_anon_function:!1,space_after_named_function:!1,brace_style:"collapse",unindent_chained_methods:!1,break_chained_methods:!1,keep_array_indentation:!1,unescape_strings:!1,wrap_line_length:0,e4x:!1,comma_first:!1,operator_position:"before-newline",indent_empty_lines:!1},jsBeautifyPreRec={indent_size:2,indent_char:" ",indent_with_tabs:!1,editorconfig:!1,eol:"\n",end_with_newline:!0,indent_level:0,preserve_newlines:!0,max_preserve_newlines:2,space_in_paren:!1,space_in_empty_paren:!1,jslint_happy:!1,space_after_anon_function:!1,space_after_named_function:!1,brace_style:"collapse",unindent_chained_methods:!1,break_chained_methods:!0,keep_array_indentation:!1,unescape_strings:!1,wrap_line_length:0,e4x:!1,comma_first:!1,operator_position:"before-newline",indent_empty_lines:!0};async function checkForAutomation(e=100){let t=document.getElementById("recTextCss").innerText.replace(/\s\s+/g,"");await waitAlwaysForMs(e);let n=t.replaceAll(" "," ");await waitAlwaysForMs(e);let i=n.replace(/[\t\n\r]/gm,"");await waitAlwaysForMs(e);let o=i.replaceAll(" "," ");await waitAlwaysForMs(e);let s=document.getElementById("recTextJs").innerText.split("\n"),a=[];for(let e=0;e<=s.length;e++)if(s[e]&&void 0!==s[e])if(s[e].startsWith("const ")||s[e].startsWith("let ")||s[e].startsWith("var ")||s[e].includes(" =")||s[e].includes(" +=")||s[e].includes(" -="))s[e].endsWith(",")||s[e].endsWith("(")||s[e].endsWith("[")||s[e].endsWith(".")||s[e].endsWith("|")||s[e].endsWith("{")||s[e].endsWith("?")||s[e].endsWith("!")||s[e].endsWith("=")||s[e].endsWith("+")||s[e].endsWith("-")||s[e].endsWith("*")||s[e].endsWith(";")||s[e].endsWith(":")||s[e].endsWith("^")||s[e].endsWith("&")?a.push(s[e]):(jsline=s[e]+";",a.push(jsline));else if(s[e].endsWith(")")||s[e].endsWith("}"))if(s[e+1]&&void 0!==s[e+1])s[e+1].trim().startsWith("=")||s[e+1].trim().startsWith("+")||s[e+1].trim().startsWith("-")||s[e+1].trim().startsWith("*")||s[e+1].trim().startsWith("/")||s[e+1].trim().startsWith("?")||s[e+1].trim().startsWith(".")||s[e+1].trim().startsWith("|")||s[e+1].trim().startsWith("{")||s[e+1].trim().startsWith("!")||s[e+1].trim().startsWith(";")||s[e+1].trim().startsWith("^")||s[e+1].trim().startsWith(":")||s[e+1].trim().startsWith(",")||s[e+1].trim().startsWith("&")?a.push(s[e]):(jsline=s[e]+";",a.push(jsline));else{let t=s[e]+";";a.push(t)}else a.push(s[e]);else{let e=" ";a.push(e)}await waitAlwaysForMs(2400);let r,c=a.join("\n");await waitAlwaysForMs(e);await modifyText("https://codejs.com/removeComments",{data:c}).then((e=>{r=JSON.parse(e)[0].txtProcess}));await waitAlwaysForMs(1500);let l=r.replace(/\s\s+/g,"");await waitAlwaysForMs(e);let d=l.replace(/[\t]/gm,"");await waitAlwaysForMs(e);const p=js_beautify(d,jsBeautifyRecOptions),m=html_beautify(document.getElementById("recTextHtml").innerText,cssBeautifyRecOptions),u=css_beautify(o,cssBeautifyRecOptions),h=await prepRecText(u),w=await prepRecTextReturn(h),f=await prepRecTextFinal(w),y=await prepRecText(p),g=await prepRecTextReturn(y),v=await prepRecTextFinalJs(g);if(m.length>5&&!0===isAutoRec&&htmlIteration<=0)document.getElementById("htmlToggleBtn").click(),typeSentence(m,htmlCodeEdit),htmlIteration++;else if(u.length>5&&!0===isAutoRec&&cssIteration<=0)document.getElementById("cssToggleBtn").click(),typeSentence(f.replace(/\)\);/g,"); "),cssCodeEdit),cssIteration++;else{if(!(p.length>5&&!0===isAutoRec&&jsIteration<=0))return runCss(),void recShowResult();document.getElementById("jsToggleBtn").click(),typeSentence(v,jsCodeEdit),jsIteration++}}function recShowResult(){document.getElementById("fullScreenBottomCornerBtn").click(),setTimeout((()=>{document.getElementsByClassName("menu-item-views item-1")[0].click()}),3e3),setTimeout((()=>{document.getElementsByClassName("menu-item-views item-2")[0].click()}),6e3),setTimeout((()=>{document.getElementsByClassName("menu-item-views item-3")[0].click()}),9e3),setTimeout((()=>{goSmallScreenShortcut()}),12e3),setTimeout((()=>{stopRecording()}),15e3),setTimeout((()=>{saveFileAfterVideo()}),18e3)}function prepRecText(e){return new Promise((t=>{setTimeout((()=>{t(e.split(/\r?\n/).join("£ö£").replace(/\s\s+/g,"").replaceAll("  ",""))}),100)}))}function prepRecTextReturn(e){return new Promise((t=>{setTimeout((()=>{t(e.replace(/£ö££ö£/g,"£ö£"))}),100)}))}function prepRecTextFinal(e){return new Promise((t=>{setTimeout((()=>{t(e.replace(/£ö£}/g,"}").replace(/£ö£/g,"\n"))}),150)}))}function prepRecTextFinalJs(e){return new Promise((t=>{setTimeout((()=>{t(e.replace(/£ö£/g,"\n"))}),150)}))}function precRecTextTabs(e){return new Promise((t=>{setTimeout((()=>{t(e.replace(/\s\s+/g,""))}),150)}))}function waitAlwaysForMs(e){return new Promise((t=>setTimeout(t,e)))}async function typeSentence(e,t,n=25){const i=t.getBoundingClientRect();document.documentElement;const o=i.left,s=(i.top,window.getSelection()),a=document.createRange();t.innerText="",s.removeAllRanges(),a.selectNodeContents(t),a.collapse(!1),s.addRange(a),t.focus();const r=e.split("");let c=0;for(;c<r.length;){if(await waitForMs(n),t.classList.contains("htmlCodeBlock"))t.append(r[c]),s.removeAllRanges(),a.selectNodeContents(t),a.collapse(!1),s.addRange(a),t.focus(),runHtml(),"\n"!=r[c-1]&&"\r"!=r[c-1]&&"\r\n"!=r[c-1]||(t.scrollTop=t.scrollHeight);else if(t.classList.contains("cssCodeBlock"))if("("==r[c])t.dispatchEvent(new KeyboardEvent("keydown",{key:r[c]}));else if("{"==r[c])t.dispatchEvent(new KeyboardEvent("keydown",{key:r[c]}));else if("["==r[c])t.dispatchEvent(new KeyboardEvent("keydown",{key:r[c]}));else if("}"==r[c]){let e=window.getSelection();e.collapseToStart();let i=await saveCaret(t);e.modify("extend","forward","line");const o=e.toString().indexOf("}");await getCaretCharOffset(t);restoreCaret(t,i),await waitForMs(n);for(let e=0;e<=o;e++)moveCaretJs();await waitForMs(n)}else")"==r[c]||"]"==r[c]?moveCaret():"\n"==r[c]||"\r"==r[c]||"\r\n"==r[c]?(dispatchReturn(t),await waitForMs(n),t.scrollTop=t.scrollHeight):document.execCommand("insertText",!1,r[c]);else t.classList.contains("jsCodeBlock")&&(typeJsCodeRec(t,r[c]),await waitForMs(n));const e=await getCaretGlobalPosition();t.clientWidth<e.left-o&&"\n"!=r[c]?t.scrollLeft=e.left-o-t.clientWidth+editorPadStyle:"\n"==r[c]&&lastPrecedingLineIndent<24&&(t.scrollLeft=0),await waitForMs(25),c++}checkForAutomation()}async function typeJsCodeRec(e,t){if("("==t)e.dispatchEvent(new KeyboardEvent("keydown",{key:t}));else if("{"==t)e.dispatchEvent(new KeyboardEvent("keydown",{key:t}));else if("["==t)e.dispatchEvent(new KeyboardEvent("keydown",{key:t}));else if("}"==t){let t=window.getSelection();t.collapseToStart();let n=await saveCaret(e);t.modify("extend","forward","line");const i=t.toString().indexOf("}");await getCaretCharOffset(e);restoreCaret(e,n),await waitForMs(10);for(let e=0;e<=i;e++)moveCaretJs();await waitForMs(10)}else")"==t||"]"==t?(moveCaretJs(),await waitForMs(10)):"\n"==t||"\r"==t||"\r\n"==t?(await waitForMs(50),dispatchReturn(e),await waitForMs(10),e.scrollTop=e.scrollHeight):document.execCommand("insertText",!1,t)}function waitForMs(e){return new Promise((t=>setTimeout(t,e)))}function moveCaret(){window.getSelection().modify("move","forward","word")}function moveCaretJs(){window.getSelection().modify("move","forward","character")}function getCaretCharOffset(e){var t=0;if(window.getSelection){var n=window.getSelection().getRangeAt(0),i=n.cloneRange();i.selectNodeContents(e),i.setEnd(n.endContainer,n.endOffset),t=i.toString().length}else if(document.selection&&"Control"!=document.selection.type){var o=document.selection.createRange(),s=document.body.createTextRange();s.moveToElementText(e),s.setEndPoint("EndToEnd",o),t=s.text.length}return t}function dispatchReturn(e){e.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",keyCode:13,which:13,shiftKey:!1,ctrlKey:!1,metaKey:!1,isTrusted:!0}))}function playRecording(){rc.classList.remove("sleepyBtn"),recordedVideo.classList.remove("sleepyBtn")}function saveFileAfterVideo(){const e=document.getElementById("fileAuthorId").innerText;if(null===localStorage.getItem("QJSKEY"))return pleaseLogIn(),void hideSpinner();if(localStorage.QJSID!=e)return void hideSpinner();const t=document.getElementById("fileId").innerText,n=localStorage.QJSKEY,i=localStorage.QJSID,o=htmlCodeEdit.innerText,s=cssCodeEdit.innerText,a=jsCodeEdit.innerText,r=localStorage[thisFileId+"todo-list"],c=document.getElementById("textbox").innerHTML;let l,d;a.length+o.length+s.length<=100?(l="",d="lowCount"):a.length>o.length?(l="JavaScript function & code example",d="js"):s.length>o.length?(l="Pure CSS 3 style",d="css"):(l="",d="html");const p=document.getElementById("librariesData").innerText,m=document.getElementById("customTagsData").innerText,u=fileName+" "+c+" "+p,h=window.frames[0].document.body.innerHTML.replaceAll("<script",'<script type="text/javascript"'),w=(new Date).toISOString().slice(0,10);!async function(f){const y={projectDescription:l,projectType:d,hostData:h,saveFileId:t,fileName:fileName,userKey:n,userId:i,fileAuthor:fileAuthor,fileOGAuthorId:e,saveHtmlData:o,fileKeywords:u,saveCssData:s,saveJsData:a,librariesData:p,customTagsData:m,todoData:r,comments:comments,saveDate:w,readMeTXTFile:c},g=await fetch(`${window.location.origin}/saveAfterVideoRec`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)}),v=await g.json(),S=JSON.parse(v)[0].fileSaved.toString().toLowerCase();"changessaved"===S?setTimeout((()=>{saveQodeJSFile(),changesSaved()}),500):"usernotsignedin"===S?pleaseLogIn():"permissiondenied"===S&&permissionDenied()}(event)}async function modifyText(e="",t={}){return(await fetch(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)})).json()}async function typeJS(){}function beautifyCode(){htmlCodeEdit.textContent=html_beautify(htmlCodeEdit.textContent,options),cssCodeEdit.textContent=css_beautify(cssCodeEdit.textContent,options),jsCodeEdit.textContent=js_beautify(jsCodeEdit.textContent,jsBeautifyRecOptions),runHtml(),runCss(),runJs()}saveCaret=function(e){var t=window.getSelection().getRangeAt(0),n=t.cloneRange();n.selectNodeContents(e),n.setEnd(t.startContainer,t.startOffset);var i=n.toString().length;return{start:i,end:i+t.toString().length}},restoreCaret=function(e,t){var n=0,i=document.createRange();i.setStart(e,0),i.collapse(!0);for(var o,s=[e],a=!1,r=!1;!r&&(o=s.pop());)if(3==o.nodeType){var c=n+o.length;!a&&t.start>=n&&t.start<=c&&(i.setStart(o,t.start-n),a=!0),a&&t.end>=n&&t.end<=c&&(i.setEnd(o,t.end-n),r=!0),n=c}else for(var l=o.childNodes.length;l--;)s.push(o.childNodes[l]);var d=window.getSelection();d.removeAllRanges(),d.addRange(i)},window.addEventListener("load",(()=>{startButton=document.querySelector(".start-recording"),stopButton=document.querySelector(".stop-recording"),downloadButton=document.querySelector(".download-video"),recordedVideo=document.querySelector(".recorded-video")}));